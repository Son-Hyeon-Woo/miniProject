{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>QUIZ</title>
    <link href="{% static 'css/custom_style.css' %}" rel="stylesheet" />

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
        
</head>

<body>
<!-- ìƒë‹¨ë°”ë¥¼ í‘œì‹œí•  div ì…ë‹ˆë‹¤ -->
<nav class="Hyemin">
    <div id = 'hello' style = 'text-align: center;'>ğŸŒ ì´ ê³³ì„ ë§ì¶°ë³¼ê¹Œìš”? ğŸŒ</div>
    <button class="gohome custombtn Hyemin" 
            id="submitButton" 
            type="botton" 
            onclick="location.href='/map/home'"
            style = "padding: 0.2rem 1.5%; border-radius : 2rem"> í™ˆìœ¼ë¡œ </button></div>
    <a class="login btn gmarket" 
        style = "background-color : #50727272; top : 13px; right : 35px; height : 3.5rem; width : 3.5rem;"
        href = "">
        <img src="{% static 'assets/img/smile.png' %}" width=45px, height=45px>
        <a  id = 'user_info' 
            class = 'gmarket'
            style = ' top:15px; right : 100px; width : 180px;'> ë‹¤ë¥¸ ì¥ì†Œë¡œ ê°ˆë˜ìš”! â–¶ï¸
        </a> 
    </a>

    <a class="login btn gmarket" 
        style = "cursor: pointer; background-color : #50727272; top : 13px; right : 310px; height : 3.5rem; width : 3.5rem;"
        id = "reset">
        <img src="{% static 'assets/img/reset.png' %}" width=45px, height=45px>
        <a  id = 'user_info' 
            class = 'gmarket'
            style = 'top:45px; right : 150px; width : 140;'>    â—€ï¸ ì‹œì‘ ìœ„ì¹˜ë¡œ!
        </a> 
    </a>


</nav>

<!-- ë¡œë“œë·°ë¥¼ í‘œì‹œí•  div ì…ë‹ˆë‹¤ -->
<div  id="roadview" style="position : relative; top : 20px; width:100%;height:750px;border-radius: 5px"></div>

<!-- ë¯¸ë‹ˆë§µë¥¼ í‘œì‹œí•  div ì…ë‹ˆë‹¤ -->
<div id="minimap" class = 'minimap'></div>

<!-- ì œì¶œ í›„ íŒì—… ë„ìš°ëŠ” div-->
<div>
    <button class = 'custombtn gmarket' 
            id="show" 
            style = 'visibility : hidden; position : relative; left : 35%; bottom : -1cm '> ì œì¶œí•˜ê¸° </button>
    <div class="background">
        <div class="window">
            <div class="popup">
                <p id = 'dist' class = 'gmarket'></p>
                <div class="popup" id = 'popanswer'></div>
                <button id="close" class = 'gmarket custombtn' style = 'padding : 0.2rem 4rem; bottom : -6%'>ì ìˆ˜ í™•ì¸</button>
            </div>
        </div>
    </div>
</div>


<!-- APIí‚¤ ì¸ì¦-->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=82cdfefd8c371330aa8531c5f89338c6"></script>
<script>
let start = new Date(); //í”Œë ˆì´ íƒ€ì„ ê¸°ë¡ìš©
document.body.classList.add("reveal"); // í™”ë©´ì „í™˜ íš¨ê³¼ìš©

let latlong = JSON.parse("{{ latlong_json|escapejs }}");     //viewì—ì„œ ë„˜ì–´ë…¼ jsonë°ì´í„° js ë³€ìˆ˜ë¡œ ì„ ì–¸


// * * * * * * * * * * * * * * * * * * ë¡œë“œë·° JS  * * * * * * * * * * * * * * * * * * * * * *
var roadviewContainer = document.getElementById('roadview'); //ë¡œë“œë·°ë¥¼ í‘œì‹œí•  div
var roadview = new kakao.maps.Roadview(roadviewContainer);   //ë¡œë“œë·° ê°ì²´
var roadviewClient = new kakao.maps.RoadviewClient();        //ì¢Œí‘œë¡œë¶€í„° ë¡œë“œë·° íŒŒë…¸IDë¥¼ ê°€ì ¸ì˜¬ ë¡œë“œë·° helperê°ì²´
var position = new kakao.maps.LatLng(latlong['lat'], latlong['long']);  // ë„˜ì–´ì˜¨ Jsonë°ì´í„°ì—ì„œ ìœ„,ê²½ë„ ì¶”ì¶œ

// íŠ¹ì • ìœ„ì¹˜ì˜ ì¢Œí‘œì™€ ê°€ê¹Œìš´ ë¡œë“œë·°ì˜ panoIdë¥¼ ì¶”ì¶œí•˜ì—¬ ë¡œë“œë·°ë¥¼ ë„ìš´ë‹¤.
roadviewClient.getNearestPanoId(position, 50, function(panoId) {
    roadview.setPanoId(panoId, position); //panoIdì™€ ì¤‘ì‹¬ì¢Œí‘œë¥¼ í†µí•´ ë¡œë“œë·° ì‹¤í–‰
});

document.querySelector("#reset").addEventListener("click", reset);
function reset() {
    roadviewClient.getNearestPanoId(position, 50, function(panoId) {
        roadview.setPanoId(panoId, position); //panoIdì™€ ì¤‘ì‹¬ì¢Œí‘œë¥¼ í†µí•´ ë¡œë“œë·° ì‹¤í–‰
    });
}



// * * * * * * * * * * * * * * * * * * ë¯¸ë‹ˆë§µ JS * * * * * * * * * * * * * * * * * * * * * *
var mapContainer = document.getElementById('minimap'), // ì¢Œì¸¡í•˜ë‹¨ ë¯¸ë‹ˆë§µì„ í‘œì‹œí•  div 
mapOption = { 
    center: new kakao.maps.LatLng(35.87152628630865, 128.60172139697093), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
    level: 3                                                              // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
};
var map = new kakao.maps.Map(mapContainer, mapOption); // ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤

var minimap = document.getElementById('minimap');   //htmlì—ì„œ ë¯¸ë‹ˆë§µ ê°ì²´ ê°€ì ¸ì™€ì„œ
minimap.style.width = '20%'                         // ì¼ë‹¨ ê°€ë¡œ 20%
minimap.style.height = '26%'                        //      ì„¸ë¡œ 26% ì„¤ì • (ì´ë ‡ê²Œ ì•ˆí•˜ë©´ ë§ˆì»¤ ì´ìƒí•˜ê²Œ ì°í˜)
minimap.style.opacity = '0.7'

var marker = new kakao.maps.Marker({     // ì§€ë„ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ì— í‘œì¶œí•  ë§ˆì»¤ì…ë‹ˆë‹¤
    position: map.getCenter()            // ì§€ë„ ì¤‘ì‹¬ì¢Œí‘œì— ë§ˆì»¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ 
}); 
marker.setMap(map);                      // ì§€ë„ì— ë§ˆì»¤ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤

kakao.maps.event.addListener(map, 'mouseout', function() { // ë¯¸ë‹ˆë§µì—ì„œ ë§ˆìš°ìŠ¤ê°€ ë‚˜ê°€ë©´ ë¯¸ë‹ˆë§µ ì‘ì•„ì§€ëŠ” í•¨ìˆ˜
    minimap.style.width = '20%'
    minimap.style.height = '26%'
    minimap.style.opacity = '0.8'
});
kakao.maps.event.addListener(map, 'mouseover', function() {// ë¯¸ë‹ˆë§µì—ì„œ ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë¯¸ë‹ˆë§µ ì»¤ì§€ëŠ” í•¨ìˆ˜
    minimap.style.width = '30%'
    minimap.style.height = '40%'
    minimap.style.opacity = '1'
});

// ì§€ë„ì— í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤
// ì§€ë„ë¥¼ í´ë¦­í•˜ë©´ ë§ˆì§€ë§‰ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤
// í´ë¦­ìœ¼ë¡œ ìƒê¸°ëŠ” ì •ë³´ë¥¼ í•¨ìˆ˜ ì™¸ë¶€ì—ì„œë„ ì“°ê¸°ìœ„í•´ ë¯¸ë¦¬ ì „ì—­ë³€ìˆ˜ ì„ ì–¸
var latlng;
kakao.maps.event.addListener(map, 'click', function(mouseEvent) {  
    // í´ë¦­í•œ ìœ„ë„, ê²½ë„ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ 
    latlng = mouseEvent.latLng; 
    // ë§ˆì»¤ ìœ„ì¹˜ë¥¼ í´ë¦­í•œ ìœ„ì¹˜ë¡œ ì˜®ê¹ë‹ˆë‹¤
    marker.setPosition(latlng);


    let goanswer = document.getElementById('show'); // ë¯¸ë‹ˆë§µì„ í´ë¦­í•˜ë©´ ì •ë‹µ ì œì¶œ ë²„íŠ¼ì´ í™œì„±í™”
    goanswer.style.visibility = 'visible';
});


// * * * * * * * * * * * * * * * * * * íŒì—… ì§€ë„ JS * * * * * * * * * * * * * * * * * * * * * *
// ì œì¶œí•˜ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ì•¼ ìƒê¸°ëŠ” ì§€ë„ë¥¼ ìœ„í•œ í•¨ìˆ˜
var dist = 0;
let point = 0;

function show() {
    document.querySelector(".background").className = "background show";

    var mapContainer2 = document.getElementById('popanswer'), // ì§€ë„ë¥¼ í‘œì‹œí•  div 
    mapOption2 = { 
        center: new kakao.maps.LatLng(latlng.getLat(), latlng.getLng()), // ì§€ë„ì˜ ì¤‘ì‹¬ì¢Œí‘œ
        level: 4 // ì§€ë„ì˜ í™•ëŒ€ ë ˆë²¨
    };
    // íŒì—… ì§€ë„ë¥¼ í‘œì‹œí•  divì™€  ì§€ë„ ì˜µì…˜ìœ¼ë¡œ  ì§€ë„ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var ansmap = new kakao.maps.Map(mapContainer2, mapOption2); 

    ansmap.setLevel(7, {  // ì •ë‹µ ì œì¶œ í›„ í™”ë©´ ì»¤ì§€ëŠ” íš¨ê³¼
        animate: {duration : 1000},
        anchor: new kakao.maps.LatLng(latlng.getLat(), latlng.getLng())
    });

    setTimeout(function(){  // ì •ë‹µ ì œì¶œ í›„ í™”ë©´ ì´ë™í•˜ëŠ” íš¨ê³¼
        var moveLatLon = new kakao.maps.LatLng(latlong['lat'], latlong['long']);
        ansmap.panTo(moveLatLon);
    }, 1200);

    // íŒì—… ì§€ë„ì— í‘œì‹œë  **ì •ë‹µìœ„ì¹˜** ë§ˆì»¤
    let ansmarker_src = "{% static 'assets/img/redmarker.png' %}"
        ansmarker_size = new kakao.maps.Size(29, 33)
        ansmarker_option = {offset: new kakao.maps.Point(14.5, 33)};
    var ansmarker_image = new kakao.maps.MarkerImage(ansmarker_src, ansmarker_size, ansmarker_option),
        markerPosition = new kakao.maps.LatLng(latlong['lat'], latlong['long']); // ë§ˆì»¤ê°€ í‘œì‹œë  ìœ„ì¹˜ì…ë‹ˆë‹¤
    var ansmarker = new kakao.maps.Marker({
        position: markerPosition, 
        image: ansmarker_image // ë§ˆì»¤ì´ë¯¸ì§€ ì„¤ì • 
    });
    ansmarker.setMap(ansmap);



    // íŒì—… ì§€ë„ì— í‘œì‹œë  **ì œì¶œìœ„ì¹˜** ë§ˆì»¤
    var submitmarkerPosition  = new kakao.maps.LatLng(latlng.getLat(), latlng.getLng());
    var submit_marker = new kakao.maps.Marker({
        position: submitmarkerPosition
    });
    submit_marker.setMap(ansmap);    

    // íŒì—… ì§€ë„ì— í‘œì‹œë  í´ë¦¬ê³¤ ë¼ì¸
    // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œ ë°°ì—´ì…ë‹ˆë‹¤. ì´ ì¢Œí‘œë“¤ì„ ì´ì–´ì„œ ì„ ì„ í‘œì‹œí•©ë‹ˆë‹¤
    var linePath = [
    new kakao.maps.LatLng(latlong['lat'], latlong['long']),
    new kakao.maps.LatLng(latlng.getLat(), latlng.getLng())
    ];

    var polyline = new kakao.maps.Polyline({
        path: linePath, // ì„ ì„ êµ¬ì„±í•˜ëŠ” ì¢Œí‘œë°°ì—´ ì…ë‹ˆë‹¤
        strokeWeight: 5, // ì„ ì˜ ë‘ê»˜ ì…ë‹ˆë‹¤
        strokeColor: '#FFAE00', // ì„ ì˜ ìƒ‰ê¹”ì…ë‹ˆë‹¤
        strokeOpacity: 0.7, // ì„ ì˜ ë¶ˆíˆ¬ëª…ë„ ì…ë‹ˆë‹¤ 1ì—ì„œ 0 ì‚¬ì´ì˜ ê°’ì´ë©° 0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ íˆ¬ëª…í•©ë‹ˆë‹¤
        strokeStyle: 'solid' // ì„ ì˜ ìŠ¤íƒ€ì¼ì…ë‹ˆë‹¤
    });

    polyline.setMap(ansmap);  
    
    //ë‘ ì¢Œí‘œ ì‚¬ì´ì˜ ê±°ë¦¬ ì¶œë ¥í•˜ê¸°
    dist = polyline.getLength(); 
    if (dist < 1000) {
        document.getElementById("dist").innerHTML='ì •ë‹µ! ê±°ë¦¬ëŠ” : ' + Math.round(dist) + 'ë¯¸í„° ì…ë‹ˆë‹¤';
    }
    else {
        document.getElementById("dist").innerHTML='ì•„ì‰¬ì›Œìš”! ê±°ë¦¬ëŠ” : ' + Math.round(dist) + 'ë¯¸í„° ì…ë‹ˆë‹¤';
    }
    
    //ë‘ ì¢Œí‘œê°€ ë³´ì´ë„ë¡ ì§€ë„ë¥¼ ì¡°ì •í•¨
    var points = [
    new kakao.maps.LatLng(latlong['lat'], latlong['long']),
    new kakao.maps.LatLng(latlng.getLat(), latlng.getLng())
    ];
    // ì§€ë„ë¥¼ ì¬ì„¤ì •í•  ë²”ìœ„ì •ë³´ë¥¼ ê°€ì§€ê³  ìˆì„ LatLngBounds ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
    var bounds = new kakao.maps.LatLngBounds();    
    var i
    for (i = 0; i < points.length; i++) {        
        // LatLngBounds ê°ì²´ì— ì¢Œí‘œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤
        bounds.extend(points[i]);
    }
    setTimeout(function(){
        ansmap.setBounds(bounds);
    }, 2500);


    //ì ìˆ˜ë¥¼ ë¡œì»¬ì— ì €ì¥
    point = 1000 - Math.round(dist);

    if (0 <= (1000 - Math.round(dist))) {
        localStorage.setItem("point", JSON.stringify(point));
    }   else {
            point = 0;
            localStorage.setItem("point", JSON.stringify(point));
        }

    
    let place_for =latlong['ID'];
    localStorage.setItem("ID_near", JSON.stringify(place_for));
}

document.querySelector("#show").addEventListener("click", show);
document.querySelector("#close").addEventListener("click", close);

// ì ìˆ˜í™•ì¸ ë²„íŠ¼ í´ë¦­ì‹œ í˜ì´ì§€ ì´ë™
function close() {
    document.querySelector(".background").className = "background";
    let user = JSON.parse("{{ user|escapejs }}");   //í˜„ì¬ ì‚¬ìš©ìì˜ ì •ë³´
    let end = new Date();                           // í”Œë ˆì´íƒ€ì„ ê¸°ë¡ìš©
    let play_time = Math.round((end - start) / 1000)
    let username = user['name'];

    sessionStorage.setItem("play_time", play_time );
    sessionStorage.setItem("point", point );
    sessionStorage.setItem("username", username );

    const csrftoken = getCookie('csrftoken');
    const formData = new FormData();

    formData.append('play_time', play_time);
    formData.append('point', point);
    formData.append('username', username);

    const data = axios({
        url: '/rank/ranking/',
        method: 'POST',
        data: formData,
        headers: { 'X-CSRFToken': csrftoken }
    });
        data.then(function (result) {
            window.location.href = '/rank/ranking'
        });
}
</script>
</body>
</html>